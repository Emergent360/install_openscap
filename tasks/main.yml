---
# tasks file for install_openscap
- name: install packages
  yum:
    name:
      - firewalld
      - httpd
      - openscap-scanner
      - scap-security-guide
      - python3-lxml
  become: true
  become_method: sudo

- name: 
  firewalld:
    service: http
    permanent: yes
    zone: public
    state: enabled

- name: reload firewalld
  systemd:
    state: reloaded
    enabled: yes
    name: firewalld

- name: enable httpd
  systemd:
    state: started
    enabled: yes
    name: httpd

- name: run openscap scan
  command: oscap xccdf eval \
    --fetch-remote-resources 
    --profile xccdf_org.ssgproject.content_profile_ospp \ --results-arf /tmp/arf.xml \
    --report /var/www/html/report.html \
    /usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml
  become: yes
  register: scan_result
  failed_when: scan_result.rc == 1
  
- name: grep arf.xml
  command: /usr/bin/egrep '<score' /tmp/arf.xml
  register: grep_output

- name: get score
  set_fact:
    scan_score: "{{ grep_output.stdout | regex_replace('^.*?<score.*?>(.*)<.*$', '\\1') }}"

- debug:
    msg: "{{ scan_score }}"

- debug:
    msg: "mitigate"
  when: scan_score | float <= scan_threshold | float